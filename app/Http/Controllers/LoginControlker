<?php

namespace App\Http\Controllers;

use App\Http\Requests\LoginRequest;
use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Illuminate\Foundation\Bus\DispatchesJobs;
use Illuminate\Foundation\Validation\ValidatesRequests;
use Illuminate\Http\Request;
use Illuminate\Routing\Controller as BaseController;
use InvalidLoginException;
use OauthService;

class LoginController extends BaseController
{
    use AuthorizesRequests, DispatchesJobs, ValidatesRequests, Request;

    private const HOME_PAGE_CONTROLLER = "";//TODO ホームController
    private OauthService $oauthService;

    /**
    * コンストラクタ
    */
    public function __construct()
    {
        $oauthService = OauthService::getInstance();
    }

    public function show(Request $request)
    {
        return View('sign_in');
    }

    public function login(LoginRequest $request)
    {
        session()->invalidate();
        try{
            $tokenResponse = $this->oauthService->login($request->userName, $request->password);
            session(['oauthToken' => $tokenResponse->getAutenticationToken()]);
            session(['oauthTokenExpiration' => time() + 25 * 60]);
            session(['refreshToken' => $tokenResponse->getRefreshToken()]);

            return redirect()->action(self::HOME_PAGE_CONTROLLER);
        }
        catch(InvalidLoginException $e){
            return View('sign_in')->with('formError', 'ログインに失敗しました。ユーザー名とパスワードをご確認ください。');
        }
    }

    public function logout(Request $request)
    {
        session()->invalidate();
        return redirect()->action('LoginController@show');
    }
}
